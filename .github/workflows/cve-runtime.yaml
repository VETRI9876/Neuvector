name: CVE Runtime Validation (PDF Input)

on:
  workflow_dispatch:

jobs:
  runtime-validation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config

      - name: Install PDF tools
        run: |
          sudo apt-get update
          sudo apt-get install -y poppler-utils jq

      - name: Extract CVEs and Pods from PDF
        run: |
          pdftotext reports/NeuVector_Vul_POC.pdf report.txt

          # Extract CVE blocks with argocd pods
          grep -E "CVE-[0-9]{4}-[0-9]+" report.txt > cves.txt
          grep -E "argocd-[a-zA-Z0-9-]+" report.txt | sort -u > pods.txt

      - name: Runtime validation (6 kubectl commands)
        run: |
          while read -r CVE; do
            while read -r POD; do
              echo "===================================="
              echo "CVE: $CVE"
              echo "POD: $POD"
              echo "===================================="

              echo "1) Pods in namespace"
              kubectl get pods -n argocd
              echo

              echo "2) Image"
              kubectl get pod "$POD" -n argocd \
                -o jsonpath="{.spec.containers[*].image}"
              echo -e "\n"

              echo "3) Package presence"
              kubectl exec -n argocd "$POD" -- sh -c '
                if [ -f /etc/alpine-release ]; then
                  apk info
                elif [ -f /etc/debian_version ]; then
                  dpkg -l
                elif [ -f /etc/redhat-release ]; then
                  rpm -qa
                fi
              ' || true
              echo

              echo "4) Runtime process"
              kubectl exec -n argocd "$POD" -- ps aux || true
              echo

              echo "5) Network exposure"
              kubectl exec -n argocd "$POD" -- sh -c \
                "ss -tulnp || netstat -tulnp" || true
              echo

              echo "6) Go static binary check"
              kubectl exec -n argocd "$POD" -- \
                ldd /usr/local/bin/argocd || true
              echo

            done < pods.txt
          done < cves.txt
