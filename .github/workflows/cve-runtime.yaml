name: CVE Runtime Validation (PDF Input)

on:
  workflow_dispatch:

jobs:
  runtime-validation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repo
        uses: actions/checkout@v4

      - name: Set kubeconfig
        run: |
          mkdir -p ~/.kube
          echo "${{ secrets.KUBECONFIG }}" > ~/.kube/config
          chmod 600 ~/.kube/config

      - name: Verify cluster access
        run: |
          kubectl cluster-info
          kubectl get ns

      - name: Install PDF tools
        run: |
          sudo apt-get update
          sudo apt-get install -y poppler-utils

      - name: Extract CVEs from PDF
        run: |
          pdftotext reports/NeuVector_Vul_POC.pdf report.txt
          grep -Eo "CVE-[0-9]{4}-[0-9]+" report.txt | sort -u > cves.txt

          echo "Extracted CVEs:"
          cat cves.txt

      - name: Get live Argo CD pods (authoritative)
        run: |
          kubectl get pods -n argocd \
            -o jsonpath='{range .items[*]}{.metadata.name}{"\n"}{end}' > pods.txt

          echo "Live Argo CD pods:"
          cat pods.txt

      - name: Runtime validation (6 mandatory kubectl commands)
        run: |
          while read -r CVE; do
            while read -r POD; do
              echo "===================================="
              echo "CVE: $CVE"
              echo "POD: $POD"
              echo "===================================="

              echo "1) Pods in namespace"
              kubectl get pods -n argocd
              echo

              echo "2) Image & container"
              kubectl get pod "$POD" -n argocd \
                -o jsonpath="{.spec.containers[*].image}"
              echo -e "\n"

              echo "3) Package presence (OS aware)"
              kubectl exec -n argocd "$POD" -- sh -c '
                if [ -f /etc/alpine-release ]; then
                  apk info | grep -Ei "openssl|busybox|glibc" || true
                elif [ -f /etc/debian_version ]; then
                  dpkg -l | grep -Ei "openssl|busybox|glibc" || true
                elif [ -f /etc/redhat-release ]; then
                  rpm -qa | grep -Ei "openssl|busybox|glibc" || true
                else
                  echo "Unknown OS"
                fi
              ' || true
              echo

              echo "4) Runtime process usage"
              kubectl exec -n argocd "$POD" -- ps aux | grep argocd || true
              echo

              echo "5) Network exposure"
              kubectl exec -n argocd "$POD" -- sh -c '
                command -v ss >/dev/null && ss -tulnp ||
                command -v netstat >/dev/null && netstat -tulnp ||
                echo "No network inspection tools present"
              ' || true
              echo

              echo "6) Go static binary linkage check"
              kubectl exec -n argocd "$POD" -- \
                ldd /usr/local/bin/argocd || true
              echo

            done < pods.txt
          done < cves.txt
